<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>dashboard</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous">
        <link rel="stylesheet" href="/views/dashboard/dashboard.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous">
    </script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="/css/nav/stylestaff.css">
        <link rel="stylesheet" href="/css/bootstrap.min.css">
    </head>

    <body>
        <!-- nav bar -->
        <nav class="sidebar" style="background-color: rgb(237, 228, 243)">
            <header>
                <div class="text">
                    <span><img src="/img/nav/logo.png" width="106.5%"></span>
                </div>
            </header>

            <div class="menu-bar">
                <div class="menu">
                    <ul class="menu-links">
                        <li class="nav-link">
                            <a href="/roomSta">
                                <i class='bx bx-home-alt icon'><img
                                        src="/img/nav/list.png"
                                        width="32px"></i>
                                <span class="text nav-text">Edit</span>
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="/dashstaff" id="dash">
                                <i class='bx bx-bell icon'><img
                                        src="/img/nav/dash.png"
                                        width="24px"></i>
                                <span class="text nav-text">Dashboard</span>
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="/hisStaff">
                                <i class='bx bx-pie-chart-alt icon'><img
                                        src="/img/nav/his.png" width="32px"></i>
                                <span class="text nav-text">History</span>
                            </a>
                        </li>

                    </ul>
                </div>

                <div class="bottom-content">
                    <li class>
                        <a href="/accstaff">
                            <i class='bx bx-log-out icon'><img
                                    src="/img/nav/user.png" width="25px"></i>
                            <span class="text nav-text">Account</span>
                        </a>
                    </li>

                    <li class>
                        <a href="/logout">
                            <i class='bx bx-log-out icon'><img
                                    src="/img/nav/logout.png" width="25px"></i>
                            <span class="text nav-text">Logout</span>
                        </a>
                    </li>
                </div>
            </div>

        </nav>

        <section class="home">
            <div class="fillter">
                <div class="container-fluid">
                    <form class="d-flex">
                        <!-- <h2 id="Dashboard" style="width: 40rem; color: aliceblue;">Dashboard</h2> -->
                    </form>
                    <div>
                        <div class="container">

                            <!-- content -->
                            <div class="d-flex flex-wrap " id="card">
                                <div class="card"
                                    style="width: 21rem;background-color:palegreen; border-color:darkgreen; border-width: 3px;">
                                    <div class="card-body">
                                        <h1 class="card-title"
                                            style="color: black;">Free
                                            slots</h1>
                                        <div class="card-head">
                                            <h2 id="free-slots"
                                                style="font-size: 94px; color: darkgreen;"></h2>
                                        </div>
                                    </div>
                                </div>

                                <div class="card"
                                    style="width: 21rem; background-color: lightblue; border-color: darkblue; border-width: 3px;">
                                    <div class="card-body">
                                        <h1 class="card-title"
                                            style="color: black;">Reserved
                                            slots</h1>
                                        <div class="card-head">
                                            <h2 id="reserved-slots"
                                                style="font-size: 94px; color: darkblue;"></h2>
                                        </div>
                                    </div>
                                </div>

                                <div class="card"
                                    style="width: 21rem; background-color:lightcoral; border-color: darkred; border-width: 3px;">
                                    <div class="card-body">
                                        <h1 class="card-title"
                                            style="color: black;">Disabled
                                            room</h1>
                                        <div class="card-head">
                                            <h2 id="disabled-slots"
                                                style="font-size: 94px; color: darkred; "></h2>
                                        </div>
                                    </div>
                                </div>

                                <div class="card"
                                    style="width: 21rem; background-color: lightyellow; border-color:darkgoldenrod; border-width: 3px;">
                                    <div class="card-body">
                                        <h1 class="card-title"
                                            style="color: black;">Pending
                                            slots</h1>
                                        <div class="card-head">
                                            <h2 id="pending-slots"
                                                style="color: darkgoldenrod; font-size: 94px;"></h2>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>

            </div>
        </section>
        <script>
        async function getRequestData() {
      try {
          // ดึงข้อมูลห้องจาก API /api/rooms
          const roomsResponse = await fetch('/api/rooms');
          if (!roomsResponse.ok) {
              throw new Error('Failed to fetch room data');
          }
          const rooms = await roomsResponse.json();
  
          // กำหนดค่าเริ่มต้น
          let pendingSlots = 0;
          let reservedSlots = 0;
          let freeSlots = 0;
          let disabledRoom = 0;
          let roomids = []; //get room id that disable room
          
          rooms.forEach(room => {
              if (room.status === 0) {
                  disabledRoom += 1; 
                  roomids.push(room.room_id);
              } else if (room.status === 1){
                  freeSlots += 4; 
              }
          });
          
          const requestResponse = await fetch('/api/dashboard');
          if (requestResponse.ok) {
              const requests = await requestResponse.json();
              requests.forEach(request => {
                  if (request.status === "pending") {
                      if(roomids.includes(request.room_id)){
                          ;
                      }else{
                          pendingSlots += 1, freeSlots -= 1;
                      }
                  } else if (request.status === "approved") {
                      if(roomids.includes(request.room_id)){
                          ;
                      }else{
                          reservedSlots += 1, freeSlots -= 1;
                      }
                  } else if (request.status === "rejected") {
                      ; 
                  }
              });
          } else {
              throw new Error('Failed to fetch request data');
          }
  
          // แสดงผลลัพธ์ในหน้าเว็บ
          document.getElementById('pending-slots').textContent = pendingSlots;
          document.getElementById('reserved-slots').textContent = reservedSlots;
          document.getElementById('free-slots').textContent = freeSlots;
          document.getElementById('disabled-slots').textContent = disabledRoom;
      } catch (error) {
          console.error(error.message);
          Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: error.message
          });
      }
  }
  
  // เรียกใช้งานเมื่อหน้าเว็บโหลดเสร็จสมบูรณ์
  document.addEventListener('DOMContentLoaded', function () {
      getRequestData();
  });
  
  
  
      </script>
        <script src="/js/dashboard/vanilla-tilt.js"></script>
        <script>
        VanillaTilt.init(document.querySelectorAll(".card"), {
            max: 25,
            speed: 400,
            glare: true,
            "max-glare": 1,
        });
</script>
    </body>

</html>
